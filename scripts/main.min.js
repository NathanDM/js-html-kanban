"use strict";

var KanbanDragManager = {
    onSelectItem: function (e) {
        //Store the selectedNode
        this.state.selectedNode = e.currentTarget;
        var parent = this.state.selectedNode.parentNode;
        //get the initial position of the node
        var offsetLeft = this.state.selectedNode.offsetLeft;
        var offsetTop = this.state.selectedNode.offsetTop;

        //Change the mouse cursor
        this.state.selectedNode.className += " grabbing";

        //store the mouse offset on the node
        this.state.offsetX = e.clientX - offsetLeft;
        this.state.offsetY = e.clientY - offsetTop;
    },

    onMove: function (e) {
        if (this.state.selectedNode) {
            //Move Node
            //Todo : manage right and bot (idea : let see if we can not manage this with css and scrollbar
            if (e.clientY - this.state.offsetY < 50 ) {
                this.state.selectedNode.style.top = e.clientY  - this.state.offsetY + "px";
            }
            if (e.clientX - this.state.offsetX < 0 ) {
                this.state.selectedNode.style.left = e.clientX - this.state.offsetX + "px";
            }
        }
    },
    onDeselectItem: function (e) {
        if (this.state.selectedNode) {
            //Manage special element (ei.SVG)
            if (this.state.selectedNode.className.replace) {
                this.state.selectedNode.className = this.state.selectedNode.className.replace(" grabbing", "");
            }
        }
        this.state.selectedNode = null;
        this.state.offsetX = 0;
        this.state.offsetY = 0;

    }
}

"use strict";

var StickyDragManager = {
    onSelectItem: function (e) {
        //Store the selectedNode
        this.state.selectedNode = e.currentTarget;
        var parent = this.state.selectedNode.parentNode;
        //get the initial position of the node
        var offsetLeft = this.state.selectedNode.offsetLeft;
        var offsetTop = this.state.selectedNode.offsetTop;

        //Put the node in the foreground
        parent.removeChild(this.state.selectedNode);
        parent.appendChild(this.state.selectedNode);

        //Change the mouse cursor
        this.state.selectedNode.className += " grabbing rotate";

        //store the mouse offset on the node
        this.state.offsetX = (e.clientX / this.state.scale )- offsetLeft;
        this.state.offsetY = (e.clientY / this.state.scale ) - offsetTop;
    },

    onMove: function (e) {
        if (this.state.selectedNode &&
            ( this.state.selectedNode.style.top = (e.clientY / this.state.scale ) - this.state.offsetY + "px"
                || this.state.selectedNode.style.left !== (e.clientX / this.state.scale )- this.state.offsetX + "px" )) {
            //Move Node
            this.state.selectedNode.style.top = (e.clientY / this.state.scale ) - this.state.offsetY + "px";
            this.state.selectedNode.style.left = (e.clientX / this.state.scale ) - this.state.offsetX + "px";
            e.stopPropagation();
        }
    },

    onDeselectItem: function (e) {
        //Manage special element (ei.SVG)
        if (this.state.selectedNode.className.replace) {
            this.state.selectedNode.className = this.state.selectedNode.className.replace("grabbing rotate", "");
        }

        this.state.selectedNode = null;
        this.state.offsetX = 0;
        this.state.offsetY = 0;
//        e.stopPropagation();
    }

}

"use strict";

var Draggable = {
    onMouseDown : function (e) {
        this.props.dragBoard.onSelectItem(e);
    },
    onMouseUp: function(e) {
        this.props.dragBoard.onDeselectItem(e);
    }
}

"use strict";

var Scallable = {

    manageZoom: function (e) {
        this.refs.scallable.state.scale = e.currentTarget.value / 100;
        React.findDOMNode(this.refs.scallable).style.transform = "scale(" + this.refs.scallable.state.scale  + ", " + this.refs.scallable.state.scale  + ")";
    }
}

"use strict"

/**
 * This class builds the react Application.
 *
 * @author $Author$
 */

var App = React.createClass({displayName: "App",
    mixins:[Scallable, KanbanDragManager],

    getInitialState : function () {
        return {};
    },

    render: function() {
        return (
            React.createElement("div", {onMouseMove: this.onMove}, 
                React.createElement(Header, null), 
                React.createElement(Kanban, {ref: "scallable", dragBoard: this}), 

                React.createElement("input", {className: "zoom", type: "range", min: "100", max: "200", defaultValue: "100", onChange: this.manageZoom, step: "10"})

            )
            );
    }
});

"use strict"

/**
 * This class builds the header menu
 *
 * @author $Author$
 */
var Header = React.createClass({displayName: "Header",
    getInitialState: function () {
        return {isZoomed: false};
    },
    render: function () {
        return (
            React.createElement("div", {className: "header"}, 
                React.createElement("div", {className: "topBar"}


                )
            )
            );
    }
});

"use strict";

/**
 * This class builds the new Kanban.
 *
 * @author $Author$
 */
var Kanban = React.createClass({displayName: "Kanban",

    mixins : [StickyDragManager],
    getInitialState: function () {
        var retval = {};
        retval.columns = [];

        retval.columns[0] = {
            title: "ToDo",
            displayOrder: 0
        };

        retval.columns[1] = {
            title: "WIP",
            displayOrder: 1
        };

        retval.columns[2] = {
            title: "WIP",
            displayOrder: 2
        };
        retval.scale=1;
        return retval
    },
    deselectAll: function (e) {
        if (this.state.selectedNode) {
            this.onDeselectItem(e)
        } else {
            this.props.dragBoard.onDeselectItem(e);
        }
    },
    render: function() {
        var x = 150,
            y = 0;
        var color = "#f9f9f9";

        return (
                React.createElement("div", {className: "kanban", onMouseUp: this.deselectAll, onMouseLeave: this.deselectAll, onMouseDown: this.props.dragBoard.onSelectItem, onMouseMove: this.onMove}, 
                    React.createElement(Column, {x: "0", y: "0", title: "Backlog"}), 
                this.state.columns.map(function (item, i) {
                        x += 300;
                        color = color === "white" ? "#f9f9f9" : "white";
                        return (React.createElement(Column, {color: color, x: x, y: y, title: item.title, key: i}, " ", item.title));
                    }
                ), 
                    React.createElement(Sticky, {x: "50px", y: "50px", className: "warn", dragBoard: this}), 
                    React.createElement(Sticky, {x: "50px", y: "100px", className: "info", dragBoard: this}), 
                    React.createElement(Sticky, {x: "50px", y: "150px", className: "default", dragBoard: this}), 
                    React.createElement(Sticky, {x: "50px", y: "200px", className: "danger", dragBoard: this}), 
                    React.createElement(Sticky, {x: "50px", y: "250px", className: "success", dragBoard: this})
                )
            );
    }
});

"use strict";

/**
 * This class manage a StickyNote component
 *
 * @author $Author$
 */
var Sticky = React.createClass({displayName: "Sticky",
    mixins: [Draggable],
    getInitialState : function () {
        return {offsetX:0, offsetY:0};
    },
    render: function() {
        var css = {
            top: this.props.y,
            left: this.props.x
        }
        return (
            React.createElement("div", {className: this.props.className + " sticky", style: css, onMouseDown: this.onMouseDown, onMouseUp: this.onMouseUp}, " ")
            );
    }
});

"use strict";

/**
 * This class builds the new Kanban.
 *
 * @author $Author$
 */
var Cicle = React.createClass({displayName: "Cicle",

    mixins:[Draggable],
    getInitialState: function () {
        return {}
    },

    render: function () {
        var css = {
            top: this.props.y,
            left: this.props.x
        }
        return (
            React.createElement("svg", {onMouseDown: this.onMouseDown, style: css, onMouseUp: this.onMouseUp, width: this.props.radius * 2, height: this.props.radius * 2}, 
                React.createElement("circle", {cx: this.props.radius, cy: this.props.radius, r: this.props.radius, stroke: "green", fill: "yellow"})
            )
            );
    }
});

"use strict";

/**
 * This class manage a Column component
 *
 * @author $Author$
 */
var Column = React.createClass({displayName: "Column",
    getInitialState : function () {
        return {displayOrder: 0};
    },
    render: function() {
        var css = {
            top: this.props.y,
            left: this.props.x,
            backgroundColor: this.props.color
        }
        return (
            React.createElement("div", {className: "column", style: css}, " ")
            );
    }
});

/*!
 *
 *  Web Starter Kit
 *  Copyright 2015 Google Inc. All rights reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *    https://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License
 *
 */
(function () {
  'use strict';

    React.render(React.createElement(App), document.getElementById('content'));


    // Check to make sure service workers are supported in the current browser,
  // and that the current page is accessed from a secure origin. Using a
  // service worker from an insecure origin will trigger JS console errors. See
  // http://www.chromium.org/Home/chromium-security/prefer-secure-origins-for-powerful-new-features
  if ('serviceWorker' in navigator &&
      (window.location.protocol === 'https:' ||
       window.location.hostname === 'localhost' ||
       window.location.hostname.indexOf('127.') === 0)) {
    navigator.serviceWorker.register('/service-worker.js', {
      scope: './'
    }).then(function(registration) {
      // Check to see if there's an updated version of service-worker.js with
      // new files to cache:
      // https://slightlyoff.github.io/ServiceWorker/spec/service_worker/index.html#service-worker-registration-update-method
      if (typeof registration.update === 'function') {
        registration.update();
      }

      // updatefound is fired if service-worker.js changes.
      registration.onupdatefound = function () {
        // updatefound is also fired the very first time the SW is installed,
        // and there's no need to prompt for a reload at that point.
        // So check here to see if the page is already controlled,
        // i.e. whether there's an existing service worker.
        if (navigator.serviceWorker.controller) {
          // The updatefound event implies that registration.installing is set:
          // https://slightlyoff.github.io/ServiceWorker/spec/service_worker/index.html#service-worker-container-updatefound-event
          var installingWorker = registration.installing;

          installingWorker.onstatechange = function () {
            switch (installingWorker.state) {
              case 'installed':
                // At this point, the old content will have been purged and the
                // fresh content will have been added to the cache.
                // It's the perfect time to display a "New content is
                // available; please refresh." message in the page's interface.
                break;

              case 'redundant':
                throw new Error('The installing ' +
                                'service worker became redundant.');
            }
          };
        }
      };
    }).catch(function (e) {
      console.error('Error during service worker registration:', e);
    });
  }

  // Your custom JavaScript goes here
})();
